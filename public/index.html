<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BridgeCircle - Saavutettava Bridge</title>
    <meta name="description" content="Saavutettava Bridge-sovellus, joka tukee GIB-tekoälyä pelaajana">
    <style>
/* Perustyylit ja nollaus */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: Arial, Helvetica, sans-serif;
  line-height: 1.6;
  max-width: 1200px;
  margin: 0 auto;
  padding: 1rem;
  color: #333;
  background-color: #f9f9f9;
}

/* Saavutettavuustyylit */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  margin: -1px;
  border: 0;
  padding: 0;
  overflow: hidden;
  clip: rect(0 0 0 0);
  clip-path: inset(50%);
  white-space: nowrap;
}

/* Fokustila kaikille interaktiivisille elementeille */
input:focus, 
button:focus, 
a:focus, 
select:focus, 
textarea:focus {
  outline: 3px solid #005fcc;
  outline-offset: 2px;
}

/* Typografia */
h1 {
  font-size: 1.8rem;
  margin-bottom: 1rem;
  color: #202020;
  text-align: center;
  margin-bottom: 20px;
  color: #2c3e50;
  border-bottom: 2px solid #eee;
  padding-bottom: 10px;
}

h2 {
  font-size: 1.4rem;
  margin-bottom: 0.8rem;
  color: #000000;
}

h3 {
  font-size: 1.2rem;
  margin-bottom: 0.5rem;
  color: #000000;
}

p {
  margin-bottom: 1rem;
}

a {
  color: #005fcc;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

a:visited {
  color: #4527a0;
}

/* Bridge-korttisovelluksen päälomake */
.bridge-card-manager {
  max-width: 1000px;
  margin: 0 auto;
  background-color: #ffffff;
  border-radius: 10px;
  padding: 1.5rem;
  margin: 1rem 0;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
}

/* Tietolaatikot */
.info-box, .help-text {
  background-color: #e8f4f8;
  border: 1px solid #b8d8e8;
  border-radius: 8px;
  padding: 1rem;
  margin: 1rem 0;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  color: #000000;
  font-style: italic;
}

/* Painikkeet */
.button-container {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.action-button {
  background-color: #005fcc;
  color: #FFFFFF;
  padding: 0.8rem 1.2rem;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 1rem;
  font-weight: 600;
  transition: background-color 0.2s, transform 0.1s;
  display: inline-block;
  text-align: center;
  flex: 1;
  min-width: 120px;
}

.action-button:hover:not([disabled]) {
  background-color: #004799;
}

.action-button:active:not([disabled]) {
  transform: translateY(1px);
}

.action-button:focus {
  outline: 3px solid #005fcc;
  outline-offset: 2px;
}

#undo-button {
  background-color: #C25100;
}

#undo-button:hover:not([disabled]) {
  background-color: #a84600;
}

#reset-all-button {
  background-color: #B22222;
}

#reset-all-button:hover:not([disabled]) {
  background-color: #9b1d1d;
}

#deal-button {
  background-color: #008000;
}

#deal-button:hover:not([disabled]) {
  background-color: #006400;
}

#start-game-button {
  background-color: #4B0082;
}

#start-game-button:hover:not([disabled]) {
  background-color: #3A006F;
}

.close-button {
  padding: 0.8rem 1.2rem;
  background-color: #005A9C;
  color: #FFFFFF;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 1rem;
  margin-top: 10px;
  transition: background-color 0.2s;
}

.close-button:hover {
  background-color: #004a80;
}

.action-button[disabled], 
.close-button[disabled],
input[disabled] {
  background-color: #cccccc;
  color: #666666;
  cursor: not-allowed;
}

/* Lomakkeet ja syötteet */
.card-inputs {
  display: none;
  flex-direction: column;
  gap: 20px;
  margin-bottom: 30px;
  padding: 20px;
  background-color: #FFFFFF;
  border-radius: 8px;
}

.card-inputs.show {
  display: flex;
}

.player-section, .dummy-section {
  border: 1px solid #ccc;
  padding: 15px;
  border-radius: 6px;
  background-color: #FFFFFF;
  color: #000000;
}

.input-group {
  display: flex;
  align-items: center;
  margin-bottom: 10px;
}

.input-group label {
  width: 100px;
  display: flex;
  align-items: center;
  font-weight: bold;
  color: #000000;
}

.input-group input {
  flex: 1;
  padding: 0.8rem;
  font-size: 1rem;
  border: 1px solid #ccc;
  border-radius: 6px;
  background-color: #FFFFFF;
  color: #000000;
}

input[type="text"]:focus {
  border-color: #005fcc;
}

/* Korttinäkymä */
.card-display {
  display: flex;
  flex-direction: column;
  gap: 30px;
}

.player-cards-display, .dummy-cards-display {
  border: 1px solid #ddd;
  padding: 20px;
  border-radius: 8px;
  background-color: #FFFFFF;
  color: #000000;
}

.suit-row {
  margin-bottom: 15px;
  padding-bottom: 15px;
  border-bottom: 1px solid #eee;
}

.suit-row:last-child {
  border-bottom: none;
}

.suit-symbol {
  margin-right: 5px;
  font-size: 1.2em;
}

.spades, .clubs {
  color: black;
}

.hearts, .diamonds {
  color: red;
}

.card-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 10px;
}

.card-button {
  width: 40px;
  height: 40px;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 16px;
  font-weight: bold;
  background-color: #FFFFFF;
  border: 1px solid #000000;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
}

.card-button:hover {
  transform: translateY(-5px);
  box-shadow: 0 5px 10px rgba(0,0,0,0.2);
}

.card-button:focus {
  outline: 3px solid #005fcc;
  background-color: #000000;
  color: #FFFFFF !important;
}

/* Uudet määrittelyt korttien maasymbolien ja arvojen erilliseen tyylittelyyn */
.card-suit {
  color: inherit; /* Perii värin ylemmältä tasolta */
}

.card-value {
  color: black; /* Kaikki numeroarvot mustia */
}

/* Maasymbolien värit */
.hearts-button .card-suit, 
.diamonds-button .card-suit {
  color: red;
}

.spades-button .card-suit, 
.clubs-button .card-suit {
  color: black;
}

/* Focus-tilassa kaikki tekstit valkoisia */
.card-button:focus .card-suit,
.card-button:focus .card-value {
  color: white !important;
}

.keyboard-shortcut {
  font-size: 0.9em;
  color: #FFFFFF;
  margin-left: 10px;
}

/* Status viesti */
.status-bar {
  padding: 12px;
  background: #dbeafe;
  color: #1e40af;
  border-radius: 8px;
  margin: 10px 0 20px 0;
  text-align: center;
  font-weight: 500;
}

/* Pelaajien kortit osio */
.players-info {
  display: flex;
  justify-content: space-between;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.player-info {
  background-color: #f8f8f8;
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 10px;
  width: 48%;
  margin-bottom: 10px;
}

.player-info.current {
  background-color: #e6f7ff;
  border-color: #91d5ff;
}

/* Pelatut kortit */
.game-table {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  grid-template-areas:
      ". north ."
      "west center east"
      ". south .";
  gap: 15px;
  margin: 20px 0;
  background-color: #f0f8ff;
  border-radius: 8px;
  padding: 15px;
}

.north-played { grid-area: north; text-align: center; }
.west-played { grid-area: west; text-align: left; }
.east-played { grid-area: east; text-align: right; }
.south-played { grid-area: south; text-align: center; }
.center-area { grid-area: center; text-align: center; padding: 30px 0; }

.played-card {
  display: inline-block;
  width: 45px;
  height: 60px;
  background-color: white;
  border: 1px solid #000;
  border-radius: 5px;
  text-align: center;
  line-height: 60px;
  font-size: 1.2rem;
  box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
}

.played-cards-section {
  margin-top: 20px;
  padding: 15px;
  border: 1px solid #ddd;
  border-radius: 8px;
  background-color: #FFFFFF;
}

.played-cards-list {
  list-style-type: none;
}

.played-cards-list li {
  margin-bottom: 6px;
}

.card-hearts, .card-diamonds {
  color: red;
}

.card-spades, .card-clubs {
  color: black;
}

/* Animaatiot */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.bridge-card-manager, .card-inputs.show {
  animation: fadeIn 0.3s ease-in-out;
}

/* Media queryt eri näyttökoille */
/* Pienet näytöt ja mobiililaitteet */
@media (max-width: 576px) {
  body {
    padding: 0.5rem;
  }
  
  h1 {
    font-size: 1.5rem;
  }
  
  h2 {
    font-size: 1.2rem;
  }
  
  .bridge-card-manager {
    padding: 1rem;
  }
  
  .action-button, .close-button {
    padding: 0.7rem 1rem;
    font-size: 0.95rem;
    width: 100%;
    margin-top: 0.5rem;
  }
  
  .card-inputs {
    padding: 10px;
  }
  
  .player-section, .dummy-section {
    padding: 10px;
  }
  
  .player-info {
    width: 100%;
  }
  
  .game-table {
    grid-template-columns: 1fr;
    grid-template-areas:
        "north"
        "west" 
        "center"
        "east"
        "south";
  }
}

/* Keskikokoiset näytöt (tabletit) */
@media (min-width: 577px) and (max-width: 768px) {
  body {
    padding: 0.8rem;
  }
  
  .bridge-card-manager {
    padding: 1.2rem;
  }
  
  .action-button, .close-button {
    padding: 0.75rem 1rem;
  }
  
  .card-inputs {
    flex-direction: row;
    flex-wrap: wrap;
  }
  
  .player-section, .dummy-section {
    flex: 1;
    min-width: 300px;
  }
}

/* Tummien teemojen tuki */
@media (prefers-color-scheme: dark) {
  body {
    background-color: #121212;
    color: #e0e0e0;
  }
  
  h1, h2, h3 {
    color: #f0f0f0;
  }
  
  .bridge-card-manager {
    background-color: #1e1e1e;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
  }
  
  .info-box, .help-text {
    background-color: #1a2c35;
    border-color: #2a4658;
    color: #e0e0e0;
  }
  
  .card-inputs {
    background-color: #252525;
  }
  
  .player-section, .dummy-section {
    background-color: #FFFFFF;
    border-color: #444;
    color: #000000;
  }
  
  .player-cards-display, .dummy-cards-display {
    background-color: #FFFFFF;
    border-color: #444;
    color: #000000;
  }
  
  .suit-row {
    border-bottom-color: #ddd;
  }
  
  input[type="text"] {
    background-color: #FFFFFF;
    border-color: #444;
    color: #000000;
  }
  
  .input-group label {
    color: #000000;
  }
  
  .card-button {
    background-color: #FFFFFF;
    border-color: #000000;
    color: inherit;
  }
  
  .card-button:focus {
    background-color: #000000;
    color: #FFFFFF !important;
  }
  
  .hearts-button, .diamonds-button {
    color: #ff6b6b;
  }
  
  .spades-button, .clubs-button {
    color: #000000;
  }
  
  a {
    color: #5b9eed;
  }
  
  a:visited {
    color: #bb86fc;
  }

  .status-bar {
    background-color: #2a4365;
    color: #a3bffa;
  }
  
  .played-cards-section {
    background-color: #1e1e1e;
    border-color: #444;
  }
  
  .player-info {
    background-color: #2d3748;
    border-color: #4a5568;
  }
  
  .player-info.current {
    background-color: #2a4365;
    border-color: #3182ce;
  }
  
  .game-table {
    background-color: #1a365d;
  }
  
  .played-card {
    background-color: #2d3748;
    border-color: #4a5568;
  }

  /* Varmista, että korttilueiden otsikot ovat mustia tummassa teemassa */
  .player-cards-display h2, .player-cards-display h3,
  .dummy-cards-display h2, .dummy-cards-display h3,
  .player-section h2, .player-section h3,
  .dummy-section h2, .dummy-section h3 {
    color: #000000;
  }

.card-value {
  color: black;
}

.hearts-button .card-suit, 
.diamonds-button .card-suit {
  color: #ff6b6b; /* Tumman teeman punainen maasymboleille */
}

.spades-button .card-suit, 
.clubs-button .card-suit {
  color: black;
}

.card-button:focus .card-suit,
.card-button:focus .card-value {
  color: white !important;
}
}

/* Tulostusasetukset */
@media print {
  body {
    background-color: #ffffff;
    color: #000000;
  }
  
  .button-container, .close-button {
    display: none;
  }
  
  .card-inputs {
    display: none;
  }
  
  .bridge-card-manager {
    box-shadow: none;
    border: none;
  }
  
  a {
    color: #000000;
    text-decoration: none;
  }
}
    </style>
</head>
<body>
    <div id="app" class="bridge-card-manager">
        <h1>BridgeCircle - Saavutettava Bridge</h1>
        
        <!-- Screen reader status message -->
        <div class="sr-only" id="status-message" aria-live="polite" aria-atomic="true"></div>

        <!-- Button controls -->
        <div class="button-container">
            <button id="player-input-button" class="action-button">
                Syötä omat korttisi
                <span class="keyboard-shortcut">(Alt+N)</span>
            </button>
            <button id="dummy-input-button" class="action-button">
                Syötä lepääjän kortit
                <span class="keyboard-shortcut">(Alt+M)</span>
            </button>
            <button id="undo-button" class="action-button">
                Peru viimeisin siirto
                <span class="keyboard-shortcut">(Alt+Z)</span>
            </button>
            <button id="reset-all-button" class="action-button">
                Poista kaikki kortit
            </button>
            <button id="deal-button" class="action-button">
                Jaa uudet kortit
                <span class="keyboard-shortcut">(Alt+D)</span>
            </button>
            <button id="start-game-button" class="action-button">
                Aloita peli
                <span class="keyboard-shortcut">(Alt+S)</span>
            </button>
        </div>

        <!-- Status bar -->
        <div class="status-bar" id="status-bar" role="status">
            Tervetuloa BridgeCircle-sovellukseen
        </div>
        
        <!-- Players info -->
        <div class="players-info">
            <div id="north-info" class="player-info">
                <h3>Pohjoinen (Lepääjä)</h3>
                <p>Pelaaja: <span id="north-player-type">Ihminen</span></p>
            </div>
            <div id="east-info" class="player-info">
                <h3>Itä</h3>
                <p>Pelaaja: <span id="east-player-type">GIB-tekoäly</span></p>
                <p>Kortteja: <span id="east-cards-count">13</span></p>
            </div>
            <div id="south-info" class="player-info current">
                <h3>Etelä (Sinä)</h3>
                <p>Pelaaja: <span id="south-player-type">Sinä</span></p>
            </div>
            <div id="west-info" class="player-info">
                <h3>Länsi</h3>
                <p>Pelaaja: <span id="west-player-type">GIB-tekoäly</span></p>
                <p>Kortteja: <span id="west-cards-count">13</span></p>
            </div>
        </div>

        <!-- Game table for played cards -->
        <div class="game-table" id="game-table">
            <div class="north-played" id="north-played">
                <!-- North played card will appear here -->
            </div>
            <div class="west-played" id="west-played">
                <!-- West played card will appear here -->
            </div>
            <div class="center-area" id="center-area">
                <!-- Current trick info -->
                <h3 id="current-trick-info">Odottaa pelaamista</h3>
            </div>
            <div class="east-played" id="east-played">
                <!-- East played card will appear here -->
            </div>
            <div class="south-played" id="south-played">
                <!-- South played card will appear here -->
            </div>
        </div>

        <!-- Player Cards Input Section (hidden by default) -->
        <div id="player-card-inputs" class="card-inputs">
            <section class="player-section">
                <h2 id="player-input-focus" tabindex="-1">Omat korttisi</h2>
                <div class="input-group">
                    <label for="player-spades">
                        <span class="suit-symbol spades">♠</span> Padat:
                    </label>
                    <input
                        id="player-spades"
                        type="text"
                        aria-describedby="format-help"
                        placeholder="esim. AQJt9"
                    />
                </div>
                <div class="input-group">
                    <label for="player-hearts">
                        <span class="suit-symbol hearts">♥</span> Hertat:
                    </label>
                    <input
                        id="player-hearts"
                        type="text"
                        aria-describedby="format-help"
                        placeholder="esim. KQJ"
                    />
                </div>
                <div class="input-group">
                    <label for="player-diamonds">
                        <span class="suit-symbol diamonds">♦</span> Ruudut:
                    </label>
                    <input
                        id="player-diamonds"
                        type="text"
                        aria-describedby="format-help"
                        placeholder="esim. At98"
                    />
                </div>
                <div class="input-group">
                    <label for="player-clubs">
                        <span class="suit-symbol clubs">♣</span> Ristit:
                    </label>
                    <input
                        id="player-clubs"
                        type="text"
                        aria-describedby="format-help"
                        placeholder="esim. 765"
                    />
                </div>

                <p id="format-help" class="help-text">
                    Syötä kortit käyttäen A ässälle, K kuninkaalle, Q rouvalle, J jätkälle, T kympille ja numerot 2-9.
                </p>

                <button id="close-player-inputs" class="close-button">
                    Valmis
                </button>
            </section>
        </div>

        <!-- Dummy Cards Input Section (hidden by default) -->
        <div id="dummy-card-inputs" class="card-inputs">
            <section class="dummy-section">
                <h2 id="dummy-input-focus" tabindex="-1">Lepääjän kortit</h2>
                <div class="input-group">
                    <label for="dummy-spades">
                        <span class="suit-symbol spades">♠</span> Padat:
                    </label>
                    <input
                        id="dummy-spades"
                        type="text"
                        aria-describedby="dummy-format-help"
                        placeholder="esim. K876"
                    />
                </div>
                <div class="input-group">
                    <label for="dummy-hearts">
                        <span class="suit-symbol hearts">♥</span> Hertat:
                    </label>
                    <input
                        id="dummy-hearts"
                        type="text"
                        aria-describedby="dummy-format-help"
                        placeholder="esim. At92"
                    />
                </div>
                <div class="input-group">
                    <label for="dummy-diamonds">
                        <span class="suit-symbol diamonds">♦</span> Ruudut:
                    </label>
                    <input
                        id="dummy-diamonds"
                        type="text"
                        aria-describedby="dummy-format-help"
                        placeholder="esim. QJ7"
                    />
                </div>
                <div class="input-group">
                    <label for="dummy-clubs">
                        <span class="suit-symbol clubs">♣</span> Ristit:
                    </label>
                    <input
                        id="dummy-clubs"
                        type="text"
                        aria-describedby="dummy-format-help"
                        placeholder="esim. AKQ2"
                    />
                </div>

                <p id="dummy-format-help" class="help-text">
                    Syötä kortit käyttäen A ässälle, K kuninkaalle, Q rouvalle, J jätkälle, T kympille ja numerot 2-9.
                </p>

                <button id="close-dummy-inputs" class="close-button">
                    Valmis
                </button>
            </section>
        </div>

        <div class="card-display">
            <section class="player-cards-display">
                <h2>Omat korttisi (Etelä)</h2>
                <div class="suit-row">
                    <h3>Padat</h3>
                    <div id="player-spades-buttons" class="card-buttons">
                        <!-- Kortit lisätään JavaScriptillä -->
                    </div>
                </div>
                <div class="suit-row">
                    <h3>Hertat</h3>
                    <div id="player-hearts-buttons" class="card-buttons">
                        <!-- Kortit lisätään JavaScriptillä -->
                    </div>
                </div>
                <div class="suit-row">
                    <h3>Ruudut</h3>
                    <div id="player-diamonds-buttons" class="card-buttons">
                        <!-- Kortit lisätään JavaScriptillä -->
                    </div>
                </div>
                <div class="suit-row">
                    <h3>Ristit</h3>
                    <div id="player-clubs-buttons" class="card-buttons">
                        <!-- Kortit lisätään JavaScriptillä -->
                    </div>
                </div>
            </section>

            <section class="dummy-cards-display">
                <h2>Lepääjän kortit (Pohjoinen)</h2>
                <div class="suit-row">
                    <h3>Padat</h3>
                    <div id="dummy-spades-buttons" class="card-buttons">
                        <!-- Kortit lisätään JavaScriptillä -->
                    </div>
                </div>
                <div class="suit-row">
                    <h3>Hertat</h3>
                    <div id="dummy-hearts-buttons" class="card-buttons">
                        <!-- Kortit lisätään JavaScriptillä -->
                    </div>
                </div>
                <div class="suit-row">
                    <h3>Ruudut</h3>
                    <div id="dummy-diamonds-buttons" class="card-buttons">
                        <!-- Kortit lisätään JavaScriptillä -->
                    </div>
                </div>
                <div class="suit-row">
                    <h3>Ristit</h3>
                    <div id="dummy-clubs-buttons" class="card-buttons">
                        <!-- Kortit lisätään JavaScriptillä -->
                    </div>
                </div>
            </section>
        </div>

        <!-- Pelatut kortit -->
        <section class="played-cards-section" id="played-cards-section">
            <h2>Pelatut kortit</h2>
            <div id="played-cards-container">
                <p class="text-gray-500">Ei vielä pelattuja kortteja.</p>
            </div>
        </section>
    </div>

    <script>
        // Määrittele korttimaat ja -arvot
        const maat = ["♠", "♥", "♦", "♣"];
        const arvot = ["2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K", "A"];
        
        // Pelitilamuuttujat
        let gameState = {
            players: {
                north: { type: 'human', name: 'Lepääjä' },
                east: { type: 'gib', name: 'GIB-Itä' },
                south: { type: 'human', name: 'Sinä' },
                west: { type: 'gib', name: 'GIB-Länsi' }
            },
            currentPlayer: 'south',
            gamePhase: 'setup', // 'setup', 'bidding', 'play', 'end'
            statusMessage: 'Aloita jakamalla kortit.',
            hands: {
                north: { 
                    spades: [], 
                    hearts: [], 
                    diamonds: [], 
                    clubs: [] 
                },
                south: { 
                    spades: [], 
                    hearts: [], 
                    diamonds: [], 
                    clubs: [] 
                },
                east: {
                    spades: [],
                    hearts: [],
                    diamonds: [],
                    clubs: []
                },
                west: {
                    spades: [],
                    hearts: [],
                    diamonds: [],
                    clubs: []
                }
            },
            currentTrick: [], // Nykyisen tikin kortit
            trickHistory: [], // Historia kaikista tikeistä
            tricks: { ns: 0, ew: 0 } // Tehdyt tikit
        };
        
        // Pelaajan ja lepääjän kortit
        let playerCards = {
            spades: '',
            hearts: '',
            diamonds: '',
            clubs: ''
        };

        let dummyCards = {
            spades: '',
            hearts: '',
            diamonds: '',
            clubs: ''
        };

        // Pelatut kortit ja siirtohistoria
        let playedCards = [];
        let moveHistory = [];

        // DOM-elementtien viitteet
        const statusMessageElement = document.getElementById('status-message');
        const statusBarElement = document.getElementById('status-bar');
        const resetAllButton = document.getElementById('reset-all-button');
        const playerInputButton = document.getElementById('player-input-button');
        const dummyInputButton = document.getElementById('dummy-input-button');
        const undoButton = document.getElementById('undo-button');
        const dealButton = document.getElementById('deal-button');
        const startGameButton = document.getElementById('start-game-button');
        const playerCardInputs = document.getElementById('player-card-inputs');
        const dummyCardInputs = document.getElementById('dummy-card-inputs');
        const closePlayerInputsButton = document.getElementById('close-player-inputs');
        const closeDummyInputsButton = document.getElementById('close-dummy-inputs');
        const playedCardsContainer = document.getElementById('played-cards-container');
        const currentTrickInfo = document.getElementById('current-trick-info');

        // Pelaajien info-elementit
        const northInfo = document.getElementById('north-info');
        const eastInfo = document.getElementById('east-info');
        const southInfo = document.getElementById('south-info');
        const westInfo = document.getElementById('west-info');
        const northPlayerType = document.getElementById('north-player-type');
        const eastPlayerType = document.getElementById('east-player-type');
        const southPlayerType = document.getElementById('south-player-type');
        const westPlayerType = document.getElementById('west-player-type');
        const eastCardsCount = document.getElementById('east-cards-count');
        const westCardsCount = document.getElementById('west-cards-count');

        // Pelattujen korttien alue
        const northPlayed = document.getElementById('north-played');
        const eastPlayed = document.getElementById('east-played');
        const southPlayed = document.getElementById('south-played');
        const westPlayed = document.getElementById('west-played');

        // Pelaajan korttien syöttökentät
        const playerSpadesInput = document.getElementById('player-spades');
        const playerHeartsInput = document.getElementById('player-hearts');
        const playerDiamondsInput = document.getElementById('player-diamonds');
        const playerClubsInput = document.getElementById('player-clubs');

        // Lepääjän korttien syöttökentät
        const dummySpadesInput = document.getElementById('dummy-spades');
        const dummyHeartsInput = document.getElementById('dummy-hearts');
        const dummyDiamondsInput = document.getElementById('dummy-diamonds');
        const dummyClubsInput = document.getElementById('dummy-clubs');

        // Korttipainikkeiden containerit
        const playerSpadesButtons = document.getElementById('player-spades-buttons');
        const playerHeartsButtons = document.getElementById('player-hearts-buttons');
        const playerDiamondsButtons = document.getElementById('player-diamonds-buttons');
        const playerClubsButtons = document.getElementById('player-clubs-buttons');
        const dummySpadesButtons = document.getElementById('dummy-spades-buttons');
        const dummyHeartsButtons = document.getElementById('dummy-hearts-buttons');
        const dummyDiamondsButtons = document.getElementById('dummy-diamonds-buttons');
        const dummyClubsButtons = document.getElementById('dummy-clubs-buttons');

        // Kartoita korttiarvot indekseiksi
        const cardValueMap = {
            '2': 0, '3': 1, '4': 2, '5': 3, '6': 4, '7': 5, '8': 6, '9': 7, 
            't': 8, 'j': 9, 'q': 10, 'k': 11, 'a': 12
        };

        // Kartoita maat indekseiksi
        const suitIndexMap = {
            'spades': 0,
            'hearts': 1,
            'diamonds': 2,
            'clubs': 3
        };

        // Näytä pelaajan korttien syöttönäkymä
        function showPlayerInputs() {
            dummyCardInputs.classList.remove('show');
            playerCardInputs.classList.add('show');
            setTimeout(() => {
                playerSpadesInput.focus();
            }, 100);
            announceToScreenReader('Syötä omat korttisi');
        }

        // Näytä lepääjän korttien syöttönäkymä
        function showDummyInputs() {
            playerCardInputs.classList.remove('show');
            dummyCardInputs.classList.add('show');
            setTimeout(() => {
                dummySpadesInput.focus();
            }, 100);
            announceToScreenReader('Syötä lepääjän kortit');
        }

        // Piilota pelaajan korttien syöttö
        function hidePlayerInputs() {
            playerCardInputs.classList.remove('show');
            announceToScreenReader('Korttisi on tallennettu');
        }

        // Piilota lepääjän korttien syöttö
        function hideDummyInputs() {
            dummyCardInputs.classList.remove('show');
            announceToScreenReader('Lepääjän kortit on tallennettu');
        }

        // Jäsennä korttitekstikenttä yksittäisiksi korteiksi
        function parseCards(cardString) {
            const cards = [];
            for (let i = 0; i < cardString.length; i++) {
                const card = cardString[i].toLowerCase();
                cards.push(card);
            }
            return cards;
        }

        // Muunna korttikoodi luettavaksi merkkijonoksi
        function cardToReadable(card) {
            const lowerCard = card.toLowerCase();
            if (lowerCard in cardValueMap) {
                return arvot[cardValueMap[lowerCard]];
            }
            return card.toUpperCase();
        }

        // Hae maasymboli näyttöä varten
        function suitToReadable(suit) {
            if (suit in suitIndexMap) {
                return maat[suitIndexMap[suit]];
            }
            return suit;
        }

        // Muunna maakoodi luettavaksi tekstiksi
        function suitToText(suit) {
            switch(suit) {
                case 'spades': return 'padat';
                case 'hearts': return 'hertat';
                case 'diamonds': return 'ruudut';
                case 'clubs': return 'ristit';
                default: return suit;
            }
        }

        // Ilmoita tekstiä ruudunlukijalle
        function announceToScreenReader(text) {
            statusMessageElement.textContent = '';
            setTimeout(() => {
                statusMessageElement.textContent = text;
            }, 50);
        }

        // Lue maan kortit ääneen
        function readCards(hand, suit) {
            const cardsString = hand === 'player' ? playerCards[suit] : dummyCards[suit];
            const parsedCards = parseCards(cardsString);
            
            if (parsedCards.length === 0) {
                announceToScreenReader(`Ei kortteja`);
                return;
            }
            
            // Suodata pelatut kortit pois
            const availableCards = parsedCards.filter(card => {
                const cardKey = `${hand === 'player' ? 'south' : 'north'}-${suit}-${card}`;
                return !isCardPlayed(cardKey);
            });
            
            if (availableCards.length === 0) {
                announceToScreenReader(`Ei kortteja`);
                return;
            }
            
            // Ota vain korttiarvot (ilman maan symboleja tai muuta tekstiä)
            const cardValues = availableCards.map(card => cardToReadable(card)).join(', ');
            
            // Ilmoita vain korttiarvot
            announceToScreenReader(cardValues);
            
            // Fokusoi vastaavaan maaosioon ruudunlukijan luennan jälkeen
            // Laske viive tekstin pituuden perusteella (noin 50ms per merkki)
            const readingDelay = Math.max(1000, cardValues.length * 50); // Vähintään 1 sekunti tai 50ms per merkki
            
            setTimeout(() => {
                // Hae ensimmäinen saatavilla oleva korttipainike tässä maaosiossa
                const buttonContainer = document.getElementById(`${hand}-${suit}-buttons`);
                const firstButton = buttonContainer.querySelector('button');
                
                if (firstButton) {
                    // Fokusoi ensimmäiseen korttipainikkeeseen
                    firstButton.focus();
                } else {
                    // Jos kortteja ei ole saatavilla, fokusoi maan otsikkoon
                    const suitHeading = buttonContainer.previousElementSibling;
                    if (suitHeading) {
                        suitHeading.setAttribute('tabindex', '-1');
                        suitHeading.focus();
                    }
                }
            }, readingDelay);
        }

        // Tarkista onko kortti jo pelattu
        function isCardPlayed(cardKey) {
            // Tarkista nykyisestä tikistä
            for (const play of gameState.currentTrick) {
                if (`${play.player}-${play.suit}-${play.card}` === cardKey) {
                    return true;
                }
            }
            
            // Tarkista tikki historiasta
            for (const trick of gameState.trickHistory) {
                for (const play of trick) {
                    if (`${play.player}-${play.suit}-${play.card}` === cardKey) {
                        return true;
                    }
                }
            }
            
            return false;
        }

        // Käsittele kortin pelaaminen
        function playCard(suit, card, position) {
            // Tarkista, onko nyt tämän pelaajan vuoro
            if (gameState.currentPlayer !== position) {
                updateStatus(`Ei ole nyt ${getPositionName(position)} vuoro.`);
                return;
            }
            
            // Tarkista, onko peli käynnissä
            if (gameState.gamePhase !== 'play') {
                updateStatus('Peli ei ole vielä käynnissä.');
                return;
            }
            
            // Pelataan kortti
            const play = { player: position, suit, card };
            gameState.currentTrick.push(play);
            
            // Näytä pelattu kortti
            displayPlayedCard(position, suit, card);
            
            // Ilmoita pelattu kortti
            const suitSymbol = suitToReadable(suit);
            const cardValue = cardToReadable(card);
            announceToScreenReader(`${getPositionName(position)} pelasi ${suitSymbol}${cardValue}`);
            
            // Päivitä kädet
            if (position === 'south') {
                // Poista kortti pelaajan kädestä
                gameState.hands.south[suit] = gameState.hands.south[suit].filter(c => c !== card);
                // Päivitä myös Bridge-apuri-muuttujat
                playerCards[suit] = playerCards[suit].replace(card.toLowerCase(), '');
            } else if (position === 'north') {
                // Poista kortti lepääjän kädestä
                gameState.hands.north[suit] = gameState.hands.north[suit].filter(c => c !== card);
                // Päivitä myös Bridge-apuri-muuttujat
                dummyCards[suit] = dummyCards[suit].replace(card.toLowerCase(), '');
            } else if (position === 'east') {
                // Poista kortti idän kädestä
                gameState.hands.east[suit] = gameState.hands.east[suit].filter(c => c !== card);
                // Päivitä korttien määrä näkymässä
                eastCardsCount.textContent = countCards(gameState.hands.east);
            } else if (position === 'west') {
                // Poista kortti lännen kädestä
                gameState.hands.west[suit] = gameState.hands.west[suit].filter(c => c !== card);
                // Päivitä korttien määrä näkymässä
                westCardsCount.textContent = countCards(gameState.hands.west);
            }
            
            // Siirry seuraavaan pelaajaan
            const nextPosition = getNextPosition(position);
            gameState.currentPlayer = nextPosition;
            
            // Päivitä pelaajien tila (kuka on vuorossa)
            updatePlayerStatus();
            
            // Tarkista onko tikki valmis (4 korttia pelattu)
            if (gameState.currentTrick.length === 4) {
                setTimeout(() => {
                    completeTrick();
                }, 1500); // Näytä tikki hetken ennen tikin päättämistä
            } else {
                // Jos seuraava on GIB-pelaaja, simuloi siirto
                if (gameState.players[nextPosition].type === 'gib') {
                    updateStatus(`${gameState.players[nextPosition].name} miettii siirtoaan...`);
                    setTimeout(() => {
                        simulateGIBPlay(nextPosition);
                    }, 1000);
                } else {
                    updateStatus(`${gameState.players[nextPosition].name} vuoro.`);
                }
            }
            
            // Päivitä kortit näkymässä
            renderAllCards();
            renderPlayedCards();
            
            // Tallenna pelin tila
            saveToLocalStorage();
        }
        
        // Näytä pelattu kortti pelipöydällä
        function displayPlayedCard(position, suit, card) {
            const element = document.getElementById(`${position}-played`);
            if (!element) return;
            
            const suitSymbol = suitToReadable(suit);
            const cardValue = cardToReadable(card);
            const isRed = suit === 'hearts' || suit === 'diamonds';
            
            element.innerHTML = `
                <div class="played-card ${isRed ? 'card-hearts' : 'card-spades'}">
                    ${suitSymbol}${cardValue}
                </div>
            `;
        }
        
        // Tyhjennä pelatut kortit pelipöydältä
        function clearPlayedCards() {
            northPlayed.innerHTML = '';
            eastPlayed.innerHTML = '';
            southPlayed.innerHTML = '';
            westPlayed.innerHTML = '';
        }
        
        // Päätä tikki
        function completeTrick() {
            // Määritä tikin voittaja
            const winningPlay = determineWinner(gameState.currentTrick);
            
            // Lisää tikki historiaan
            gameState.trickHistory.push([...gameState.currentTrick]);
            
            // Lisää piste oikealle parille
            if (winningPlay.player === 'north' || winningPlay.player === 'south') {
                gameState.tricks.ns += 1;
            } else {
                gameState.tricks.ew += 1;
            }
            
            // Ilmoita tikin voittaja
            updateStatus(`${getPositionName(winningPlay.player)} voitti tikin.`);
            announceToScreenReader(`${getPositionName(winningPlay.player)} voitti tikin.`);
            
            // Tyhjennä nykyinen tikki
            gameState.currentTrick = [];
            
            // Tyhjennä pelatut kortit näkymästä
            setTimeout(() => {
                clearPlayedCards();
                
                // Tarkista onko peli päättynyt
                if (isGameOver()) {
                    endGame();
                } else {
                    // Seuraava pelaaja on tikin voittaja
                    gameState.currentPlayer = winningPlay.player;
                    updatePlayerStatus();
                    
                    // Päivitä tikin tiedot
                    currentTrickInfo.textContent = `Etelä-Pohjoinen: ${gameState.tricks.ns} | Itä-Länsi: ${gameState.tricks.ew}`;
                    
                    // Jos seuraava on GIB-pelaaja, simuloi siirto
                    if (gameState.players[winningPlay.player].type === 'gib') {
                        updateStatus(`${gameState.players[winningPlay.player].name} miettii siirtoaan...`);
                        setTimeout(() => {
                            simulateGIBPlay(winningPlay.player);
                        }, 1000);
                    } else {
                        updateStatus(`${gameState.players[winningPlay.player].name} vuoro.`);
                    }
                }
            }, 1000);
            
            // Tallenna pelin tila
            saveToLocalStorage();
        }
        
        // Määritä tikin voittaja
        function determineWinner(trick) {
            if (trick.length === 0) return null;
            
            // Ensimmäinen kortti määrittää maan
            const leadSuit = trick[0].suit;
            let winningPlay = trick[0];
            let highestValue = cardValueMap[trick[0].card.toLowerCase()] || 0;
            
            for (let i = 1; i < trick.length; i++) {
                const play = trick[i];
                const value = cardValueMap[play.card.toLowerCase()] || 0;
                
                // Jos sama maa ja korkeampi arvo
                if (play.suit === leadSuit && value > highestValue) {
                    winningPlay = play;
                    highestValue = value;
                }
            }
            
            return winningPlay;
        }
        
        // Tarkista onko peli päättynyt
        function isGameOver() {
            // Peli päättyy kun kaikki 13 tikkiä on pelattu
            return gameState.trickHistory.length >= 13;
        }
        
        // Päätä peli
        function endGame() {
            gameState.gamePhase = 'end';
            
            // Näytä lopputulos
            const nsScore = gameState.tricks.ns;
            const ewScore = gameState.tricks.ew;
            
            let message = `Peli päättyi! Lopputulos: Etelä-Pohjoinen ${nsScore} - Itä-Länsi ${ewScore}.`;
            
            if (nsScore > ewScore) {
                message += ' Etelä-Pohjoinen voitti!';
            } else if (ewScore > nsScore) {
                message += ' Itä-Länsi voitti!';
            } else {
                message += ' Tasapeli!';
            }
            
            updateStatus(message);
            announceToScreenReader(message);
            
            // Päivitä näkymä
            currentTrickInfo.textContent = message;
        }
        
        // Laske korttien määrä kädessä
        function countCards(hand) {
            return Object.values(hand).reduce((sum, cards) => sum + cards.length, 0);
        }
        
        // Päivitä pelaajien tila
        function updatePlayerStatus() {
            // Poista 'current' luokka kaikilta pelaajilta
            northInfo.classList.remove('current');
            eastInfo.classList.remove('current');
            southInfo.classList.remove('current');
            westInfo.classList.remove('current');
            
            // Lisää 'current' luokka nykyiselle pelaajalle
            document.getElementById(`${gameState.currentPlayer}-info`).classList.add('current');
        }
        
        // Hae seuraava pelaaja
        function getNextPosition(position) {
            const positions = ['north', 'east', 'south', 'west'];
            const currentIndex = positions.indexOf(position);
            return positions[(currentIndex + 1) % 4];
        }

        // Peru viimeisin siirto (täytyy toteuttaa uudelleen GIB-pelaajien takia)
        function undoLastMove() {
            if (gameState.currentTrick.length === 0 && gameState.trickHistory.length === 0) {
                announceToScreenReader("Ei peruttavia siirtoja");
                return;
            }
            
            // Jos nykyisessä tikissä on kortteja, peru viimeisin
            if (gameState.currentTrick.length > 0) {
                const lastPlay = gameState.currentTrick.pop();
                
                // Palauta kortti pelaajan käteen
                if (lastPlay.player === 'south') {
                    gameState.hands.south[lastPlay.suit].push(lastPlay.card);
                    playerCards[lastPlay.suit] += lastPlay.card.toLowerCase();
                } else if (lastPlay.player === 'north') {
                    gameState.hands.north[lastPlay.suit].push(lastPlay.card);
                    dummyCards[lastPlay.suit] += lastPlay.card.toLowerCase();
                } else if (lastPlay.player === 'east') {
                    gameState.hands.east[lastPlay.suit].push(lastPlay.card);
                } else if (lastPlay.player === 'west') {
                    gameState.hands.west[lastPlay.suit].push(lastPlay.card);
                }
                
                // Päivitä korttien näkymät
                eastCardsCount.textContent = countCards(gameState.hands.east);
                westCardsCount.textContent = countCards(gameState.hands.west);
                
                // Päivitä nykyinen pelaaja
                gameState.currentPlayer = lastPlay.player;
                
                // Poista kortti pelipöydältä
                document.getElementById(`${lastPlay.player}-played`).innerHTML = '';
                
                // Ilmoita perumisesta
                const suitSymbol = suitToReadable(lastPlay.suit);
                const cardValue = cardToReadable(lastPlay.card);
                announceToScreenReader(`Peruttu ${getPositionName(lastPlay.player)} kortti ${suitSymbol}${cardValue}`);
            } 
            // Jos tikki on tyhjä mutta on tikkihistoriaa, palauta viimeisin tikki
            else if (gameState.trickHistory.length > 0) {
                // Hae viimeisin tikki historiasta
                const lastTrick = gameState.trickHistory.pop();
                
                // Palauta tikki nykyiseksi tikiksi
                gameState.currentTrick = lastTrick;
                
                // Päivitä tikit
                if (gameState.currentTrick[gameState.currentTrick.length - 1].player === 'north' || 
                    gameState.currentTrick[gameState.currentTrick.length - 1].player === 'south') {
                    gameState.tricks.ns -= 1;
                } else {
                    gameState.tricks.ew -= 1;
                }
                
                // Näytä tikin kortit pelipöydällä
                clearPlayedCards();
                for (const play of lastTrick) {
                    displayPlayedCard(play.player, play.suit, play.card);
                }
                
                // Päivitä tikin tiedot
                currentTrickInfo.textContent = `Etelä-Pohjoinen: ${gameState.tricks.ns} | Itä-Länsi: ${gameState.tricks.ew}`;
                
                // Ilmoita perumisesta
                announceToScreenReader('Peruttu viimeisin tikki');
            }
            
            // Päivitä pelaajien tila
            updatePlayerStatus();
            
            // Päivitä kortit näkymässä
            renderAllCards();
            renderPlayedCards();
            
            // Tallenna pelin tila
            saveToLocalStorage();
        }
        
        // Simuloi GIB-pelaajan siirto
        function simulateGIBPlay(gibPosition) {
            // Tarkista onko kyseessä GIB-pelaaja
            if (gameState.players[gibPosition].type !== 'gib') {
                return;
            }
            
            // Hae pelaajan käsi
            const hand = gameState.hands[gibPosition];
            
            // Tarkista että on GIB pelaajan vuoro
            if (gameState.currentPlayer !== gibPosition) {
                return;
            }
            
            // Määritä aloitusmaa jos sellainen on
            let leadSuit = null;
            if (gameState.currentTrick.length > 0) {
                leadSuit = gameState.currentTrick[0].suit;
            }
            
            // Etsi maa, jossa on kortteja
            let selectedSuit = null;
            let selectedCard = null;
            
            // Jos aiempi kortti on pelattu, seuraa maata jos mahdollista
            if (leadSuit && hand[leadSuit].length > 0) {
                selectedSuit = leadSuit;
                selectedCard = hand[leadSuit][0]; // Valitse ensimmäinen kortti tässä maassa
            } else {
                // Muuten pelaa mistä tahansa maasta
                const suits = ['spades', 'hearts', 'diamonds', 'clubs'];
                for (const suit of suits) {
                    if (hand[suit].length > 0) {
                        selectedSuit = suit;
                        selectedCard = hand[suit][0]; // Valitse ensimmäinen kortti tässä maassa
                        break;
                    }
                }
            }
            
            if (!selectedSuit || !selectedCard) {
                console.error(`GIB-pelaajalla ${gibPosition} ei ole kortteja!`);
                return;
            }
            
            // Pelaa kortti
            setTimeout(() => {
                playCard(selectedSuit, selectedCard, gibPosition);
            }, 500);
        }

        // Renderöi kortit painikkeina
        function renderCardButtons(position, suit) {
            const hand = position === 'south' ? 'player' : 'dummy';
            const containerElement = document.getElementById(`${hand}-${suit}-buttons`);
            containerElement.innerHTML = ''; // Tyhjennä olemassa olevat painikkeet
            
            const cardsString = hand === 'player' ? playerCards[suit] : dummyCards[suit];
            const parsedCards = parseCards(cardsString);
            
            // Suodata pelatut kortit pois
            const availableCards = parsedCards.filter(card => {
                return !isCardPlayed(`${position}-${suit}-${card}`);
            });
            
            // Tarkista onko vuorossa tutkittavana oleva pelaaja
            const isPlayersTurn = gameState.currentPlayer === position;
            
            // Tarkista tarvitseeko seurata maata
            let mustFollowSuit = null;
            if (gameState.currentTrick.length > 0 && isPlayersTurn) {
                mustFollowSuit = gameState.currentTrick[0].suit;
            }
            
            // Onko pelaajalla kortteja aloitusmaassa
            const hasLeadSuit = mustFollowSuit ? gameState.hands[position][mustFollowSuit].length > 0 : false;
            
            availableCards.forEach(card => {
                const button = document.createElement('button');
                
                // Aseta luokka maan perusteella väritystä varten
                let buttonClass = 'card-button';
                if (suit === 'hearts' || suit === 'diamonds') {
                    buttonClass += ' hearts-button';
                } else {
                    buttonClass += ' spades-button';
                }
                button.className = buttonClass;
                
                // Hae maasymboli
                const suitSymbol = suitToReadable(suit);
                
                // Hae korttiarvo
                const cardValue = cardToReadable(card);
                
                // Luo erilliset span-elementit maasymbolille ja kortin arvolle
                const suitSpan = document.createElement('span');
                suitSpan.className = 'card-suit'; // Luokka maasymbolille
                suitSpan.textContent = suitSymbol;
                
                const valueSpan = document.createElement('span');
                valueSpan.className = 'card-value'; // Luokka kortin arvolle
                valueSpan.textContent = cardValue;
                
                // Tyhjennä button ja lisää siihen span-elementit
                button.textContent = '';
                button.appendChild(suitSpan);
                button.appendChild(valueSpan);
                
                // Tallenna alkuperäinen korttiarvo data-attribuuttina
                button.setAttribute('data-card', card);
                button.setAttribute('data-suit', suit);
                
                // Aseta aria-label ruudunlukijoita varten
                button.setAttribute('aria-label', `${suitSymbol}${cardValue}`);
                
                // Määritä onko painike käytössä
                const isDisabled = !isPlayersTurn || 
                                  gameState.gamePhase !== 'play' || 
                                  (mustFollowSuit && hasLeadSuit && suit !== mustFollowSuit);
                
                if (isDisabled) {
                    button.disabled = true;
                }
                
                // Lisää klikkauskäsittelijä
                button.addEventListener('click', () => {
                    playCard(suit, card, position);
                });
                
                containerElement.appendChild(button);
            });
        }

        // Renderöi kaikki korttipainikkeet
        function renderAllCards() {
            renderCardButtons('south', 'spades');
            renderCardButtons('south', 'hearts');
            renderCardButtons('south', 'diamonds');
            renderCardButtons('south', 'clubs');
            renderCardButtons('north', 'spades');
            renderCardButtons('north', 'hearts');
            renderCardButtons('north', 'diamonds');
            renderCardButtons('north', 'clubs');
        }

        // Renderöi pelatut kortit
        function renderPlayedCards() {
            // Tyhjennä pelattujen korttien säiliö
            playedCardsContainer.innerHTML = '';
            
            if (gameState.trickHistory.length === 0 && gameState.currentTrick.length === 0) {
                playedCardsContainer.innerHTML = '<p>Ei vielä pelattuja kortteja.</p>';
                return;
            }
            
            let html = '<ul class="played-cards-list">';
            
            // Näytä ensin tikki historia
            gameState.trickHistory.forEach((trick, trickIndex) => {
                const winner = determineWinner(trick);
                html += `<li><strong>Tikki ${trickIndex + 1}:</strong> ${getPositionName(winner.player)} voitti</li>`;
                
                trick.forEach((play, playIndex) => {
                    const suitSymbol = suitToReadable(play.suit);
                    const cardValue = cardToReadable(play.card);
                    const isRed = play.suit === 'hearts' || play.suit === 'diamonds';
                    
                    html += `
                        <li style="margin-left: 20px;">
                            ${playIndex + 1}. ${getPositionName(play.player)}: 
                            <span class="${isRed ? 'card-hearts' : 'card-spades'}">
                                ${suitSymbol}${cardValue}
                            </span>
                        </li>
                    `;
                });
            });
            
            // Näytä sitten nykyinen tikki
            if (gameState.currentTrick.length > 0) {
                html += `<li><strong>Nykyinen tikki:</strong></li>`;
                
                gameState.currentTrick.forEach((play, playIndex) => {
                    const suitSymbol = suitToReadable(play.suit);
                    const cardValue = cardToReadable(play.card);
                    const isRed = play.suit === 'hearts' || play.suit === 'diamonds';
                    
                    html += `
                        <li style="margin-left: 20px;">
                            ${playIndex + 1}. ${getPositionName(play.player)}: 
                            <span class="${isRed ? 'card-hearts' : 'card-spades'}">
                                ${suitSymbol}${cardValue}
                            </span>
                        </li>
                    `;
                });
            }
            
            html += '</ul>';
            playedCardsContainer.innerHTML = html;
        }

        // Tallenna paikalliseen tallennustilaan
        function saveToLocalStorage() {
            localStorage.setItem('gameState', JSON.stringify(gameState));
            localStorage.setItem('playerCards', JSON.stringify(playerCards));
            localStorage.setItem('dummyCards', JSON.stringify(dummyCards));
        }

        // Lataa paikallisesta tallennustilasta
        function loadFromLocalStorage() {
            const savedGameState = localStorage.getItem('gameState');
            const savedPlayerCards = localStorage.getItem('playerCards');
            const savedDummyCards = localStorage.getItem('dummyCards');
            
            if (savedGameState) {
                gameState = JSON.parse(savedGameState);
            }
            
            if (savedPlayerCards) {
                playerCards = JSON.parse(savedPlayerCards);
                playerSpadesInput.value = playerCards.spades;
                playerHeartsInput.value = playerCards.hearts;
                playerDiamondsInput.value = playerCards.diamonds;
                playerClubsInput.value = playerCards.clubs;
            }
            
            if (savedDummyCards) {
                dummyCards = JSON.parse(savedDummyCards);
                dummySpadesInput.value = dummyCards.spades;
                dummyHeartsInput.value = dummyCards.hearts;
                dummyDiamondsInput.value = dummyCards.diamonds;
                dummyClubsInput.value = dummyCards.clubs;
            }
            
            // Päivitä pelaajien tila ja näytä pelatut kortit
            updatePlayerStatus();
            
            // Päivitä korttien määrät
            eastCardsCount.textContent = countCards(gameState.hands.east);
            westCardsCount.textContent = countCards(gameState.hands.west);
            
            // Näytä nykyisen tikin kortit
            clearPlayedCards();
            for (const play of gameState.currentTrick) {
                displayPlayedCard(play.player, play.suit, play.card);
            }
            
            // Päivitä tikin tiedot
            currentTrickInfo.textContent = gameState.currentTrick.length === 0 ? 
                `Etelä-Pohjoinen: ${gameState.tricks.ns} | Itä-Länsi: ${gameState.tricks.ew}` : 
                'Tikki kesken';
            
            // Päivitä näkymät
            renderAllCards();
            renderPlayedCards();
            
            // Päivitä tilaviesti
            updateStatus(gameState.statusMessage);
        }

        // Nollaa kaikki kortit
        function resetCards() {
            // Tyhjennä kädet
            for (const position of ['north', 'east', 'south', 'west']) {
                gameState.hands[position] = {
                    spades: [],
                    hearts: [],
                    diamonds: [],
                    clubs: []
                };
            }
            
            // Nollaa muut pelitilamuuttujat
            gameState.currentTrick = [];
            gameState.trickHistory = [];
            gameState.tricks = { ns: 0, ew: 0 };
            gameState.gamePhase = 'setup';
            gameState.currentPlayer = 'south';
            gameState.statusMessage = 'Kortit poistettu. Aloita jakamalla tai syöttämällä kortit.';
            
            // Tyhjennä apuri kortti muuttujat
            playerCards = {
                spades: '',
                hearts: '',
                diamonds: '',
                clubs: ''
            };
            
            dummyCards = {
                spades: '',
                hearts: '',
                diamonds: '',
                clubs: ''
            };
            
            // Tyhjennä syöttökentät
            playerSpadesInput.value = '';
            playerHeartsInput.value = '';
            playerDiamondsInput.value = '';
            playerClubsInput.value = '';
            dummySpadesInput.value = '';
            dummyHeartsInput.value = '';
            dummyDiamondsInput.value = '';
            dummyClubsInput.value = '';
            
            // Päivitä näkymät
            updateStatus(gameState.statusMessage);
            updatePlayerStatus();
            clearPlayedCards();
            currentTrickInfo.textContent = 'Odottaa pelaamista';
            eastCardsCount.textContent = '0';
            westCardsCount.textContent = '0';
            
            // Päivitä kortit ja pelatut kortit
            renderAllCards();
            renderPlayedCards();
            
            // Tallenna pelin tila
            saveToLocalStorage();
            
            // Ilmoita ruudunlukijalle
            announceToScreenReader('Kortit poistettu');
        }

        // Jaa uudet kortit
        function dealNewCards() {
            updateStatus('Jaetaan kortteja...');
            
            // Nollaa ensin peli
            resetCards();
            
            // Luo satunnainen jako
            generateRandomDeal();
            
            // Päivitä korttimuuttujat Bridge-apuri-formaattiin
            convertDealtCardsToBridgeAssistant();
            
            // Päivitä tilaviesti
            updateStatus('Uudet kortit jaettu! Aloita peli.');
            announceToScreenReader('Uudet kortit on jaettu');
            
            // Päivitä pelattujen korttien määrät
            eastCardsCount.textContent = '13';
            westCardsCount.textContent = '13';
        }

        // Muunna jaetut kortit Bridge-apuri-muotoon
        function convertDealtCardsToBridgeAssistant() {
            // Tyhjennä aiemmat kortit
            playerCards = {
                spades: '',
                hearts: '',
                diamonds: '',
                clubs: ''
            };
            
            dummyCards = {
                spades: '',
                hearts: '',
                diamonds: '',
                clubs: ''
            };
            
            // Muunna south (pelaaja) ja north (lepääjä) kortit
            for (const suit of ['spades', 'hearts', 'diamonds', 'clubs']) {
                // Pelaajan kortit (south)
                playerCards[suit] = gameState.hands.south[suit].join('').toLowerCase();
                
                // Päivitä syöttökentät
                const playerInput = document.getElementById(`player-${suit}`);
                if (playerInput) {
                    playerInput.value = playerCards[suit];
                }
                
                // Lepääjän kortit (north)
                dummyCards[suit] = gameState.hands.north[suit].join('').toLowerCase();
                
                // Päivitä syöttökentät
                const dummyInput = document.getElementById(`dummy-${suit}`);
                if (dummyInput) {
                    dummyInput.value = dummyCards[suit];
                }
            }
            
            // Päivitä näkymät
            renderAllCards();
            renderPlayedCards();
            
            // Tallenna pelin tila
            saveToLocalStorage();
        }

        // Luo satunnainen jako
        function generateRandomDeal() {
            // Luo pakka (52 korttia)
            const deck = [];
            const suits = ['spades', 'hearts', 'diamonds', 'clubs'];
            const values = ['2', '3', '4', '5', '6', '7', '8', '9', 'T', 'J', 'Q', 'K', 'A'];
            
            for (const suit of suits) {
                for (const value of values) {
                    deck.push({ suit, value });
                }
            }
            
            // Sekoita pakka
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]]; // Vaihda paikkaa
            }
            
            // Alusta tyhjät kädet
            for (const position of ['north', 'east', 'south', 'west']) {
                gameState.hands[position] = {
                    spades: [],
                    hearts: [],
                    diamonds: [],
                    clubs: []
                };
            }
            
            // Jaa 13 korttia kullekin pelaajalle
            const positions = ['north', 'east', 'south', 'west'];
            for (let i = 0; i < deck.length; i++) {
                const position = positions[Math.floor(i / 13)];
                const card = deck[i];
                gameState.hands[position][card.suit].push(card.value);
            }
            
            // Järjestä kortit maittain (A, K, Q, J, T, 9, ..., 2)
            for (const position of positions) {
                for (const suit of suits) {
                    gameState.hands[position][suit].sort((a, b) => {
                        return values.indexOf(b) - values.indexOf(a);
                    });
                }
            }
            
            // Päivitä pelitila
            gameState.gamePhase = 'setup';
            gameState.currentTrick = [];
            gameState.trickHistory = [];
            gameState.tricks = { ns: 0, ew: 0 };
            gameState.currentPlayer = 'south';
        }

        // Aloita peli
        function startGame() {
            // Tarkista onko kortteja
            if (!hasCards()) {
                updateStatus('Jaa ensin kortit ennen pelin aloittamista.');
                return;
            }
            
            // Alusta peli
            gameState.gamePhase = 'play';
            gameState.currentPlayer = 'south';
            gameState.currentTrick = [];
            gameState.trickHistory = [];
            gameState.tricks = { ns: 0, ew: 0 };
            
            // Päivitä pelaajien tila
            updatePlayerStatus();
            
            // Tyhjennä pelipöytä
            clearPlayedCards();
            
            // Päivitä tikin tiedot
            currentTrickInfo.textContent = 'Etelä-Pohjoinen: 0 | Itä-Länsi: 0';
            
            // Päivitä tila- ja ruudunlukijaviestit
            updateStatus('Peli alkaa! Sinun vuorosi.');
            announceToScreenReader('Peli on alkanut. Sinun vuorosi.');
            
            // Tallenna pelin tila
            saveToLocalStorage();
            
            // Päivitä näkymät
            renderAllCards();
            renderPlayedCards();
        }

        // Tarkista onko kortteja
        function hasCards() {
            return countCards(gameState.hands.south) > 0 && 
                   countCards(gameState.hands.north) > 0 && 
                   countCards(gameState.hands.east) > 0 && 
                   countCards(gameState.hands.west) > 0;
        }

        // Päivitä tilaviesti
        function updateStatus(message) {
            gameState.statusMessage = message;
            statusBarElement.textContent = message;
        }

        // Apufunktiot
        function getPositionName(position) {
            const names = { north: 'Pohjoinen', east: 'Itä', south: 'Etelä', west: 'Länsi' };
            return names[position] || position;
        }

        // Lisää kuuntelijat syöttökentille
        playerSpadesInput.addEventListener('input', (e) => {
            playerCards.spades = e.target.value.toLowerCase();
            gameState.hands.south.spades = parseCards(playerCards.spades);
            saveToLocalStorage();
            renderAllCards();
        });

        playerHeartsInput.addEventListener('input', (e) => {
            playerCards.hearts = e.target.value.toLowerCase();
            gameState.hands.south.hearts = parseCards(playerCards.hearts);
            saveToLocalStorage();
            renderAllCards();
        });

        playerDiamondsInput.addEventListener('input', (e) => {
            playerCards.diamonds = e.target.value.toLowerCase();
            gameState.hands.south.diamonds = parseCards(playerCards.diamonds);
            saveToLocalStorage();
            renderAllCards();
        });

        playerClubsInput.addEventListener('input', (e) => {
            playerCards.clubs = e.target.value.toLowerCase();
            gameState.hands.south.clubs = parseCards(playerCards.clubs);
            saveToLocalStorage();
            renderAllCards();
        });

        dummySpadesInput.addEventListener('input', (e) => {
            dummyCards.spades = e.target.value.toLowerCase();
            gameState.hands.north.spades = parseCards(dummyCards.spades);
            saveToLocalStorage();
            renderAllCards();
        });

        dummyHeartsInput.addEventListener('input', (e) => {
            dummyCards.hearts = e.target.value.toLowerCase();
            gameState.hands.north.hearts = parseCards(dummyCards.hearts);
            saveToLocalStorage();
            renderAllCards();
        });

        dummyDiamondsInput.addEventListener('input', (e) => {
            dummyCards.diamonds = e.target.value.toLowerCase();
            gameState.hands.north.diamonds = parseCards(dummyCards.diamonds);
            saveToLocalStorage();
            renderAllCards();
        });

        dummyClubsInput.addEventListener('input', (e) => {
            dummyCards.clubs = e.target.value.toLowerCase();
            gameState.hands.north.clubs = parseCards(dummyCards.clubs);
            saveToLocalStorage();
            renderAllCards();
        });

        // Lisää napsautustapahtumat painikkeille
        playerInputButton.addEventListener('click', showPlayerInputs);
        dummyInputButton.addEventListener('click', showDummyInputs);
        closePlayerInputsButton.addEventListener('click', hidePlayerInputs);
        closeDummyInputsButton.addEventListener('click', hideDummyInputs);
        resetAllButton.addEventListener('click', resetCards);
        undoButton.addEventListener('click', undoLastMove);
        dealButton.addEventListener('click', dealNewCards);
        startGameButton.addEventListener('click', startGame);

        // Määritä näppäimistön pikavalinnat
        document.addEventListener('keydown', (event) => {
            // Tarkista painetaanko Alt-näppäintä
            if (event.altKey) {
                switch (event.key) {
                    case 'n': // Alt+N - Syötä omat kortit
                        showPlayerInputs();
                        event.preventDefault();
                        break;
                    case 'm': // Alt+M - Syötä lepääjän kortit
                        showDummyInputs();
                        event.preventDefault();
                        break;
                    case 'z': // Alt+Z - Peru viimeisin siirto
                        undoLastMove();
                        event.preventDefault();
                        break;
                    case 'd': // Alt+D - Jaa uudet kortit
                        dealNewCards();
                        event.preventDefault();
                        break;
                    case 's': // Alt+S - Aloita peli
                        startGame();
                        event.preventDefault();
                        break;
                    case 'a': // Alt+A - Lue pelaajan padat
                        readCards('player', 'spades');
                        event.preventDefault();
                        break;
                    case 'h': // Alt+H - Lue pelaajan hertat
                        readCards('player', 'hearts');
                        event.preventDefault();
                        break;
                    case 'x': // Alt+X - Lue pelaajan ruudut
                        readCards('player', 'diamonds');
                        event.preventDefault();
                        break;
                    case 'c': // Alt+C - Lue pelaajan ristit
                        readCards('player', 'clubs');
                        event.preventDefault();
                        break;
                    case 'q': // Alt+Q - Lue lepääjän padat
                        readCards('dummy', 'spades');
                        event.preventDefault();
                        break;
                    case 'w': // Alt+W - Lue lepääjän hertat
                        readCards('dummy', 'hearts');
                        event.preventDefault();
                        break;
                    case 'e': // Alt+E - Lue lepääjän ruudut
                        readCards('dummy', 'diamonds');
                        event.preventDefault();
                        break;
                    case 'r': // Alt+R - Lue lepääjän ristit
                        readCards('dummy', 'clubs');
                        event.preventDefault();
                        break;
                    default:
                        break;
                }
            }
        });

        // Alusta sovellus
        loadFromLocalStorage();
    </script>
</body>
</html>
